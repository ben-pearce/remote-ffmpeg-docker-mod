#!/usr/bin/env bash
set -euo pipefail

BASH_UNIT_VERSION="2.3.3"
BASH_UNIT_SHA256="a2f76ddca88e2bef7c628c8cac6bf68b93a388fce143f6a4dc770fe1b3584307"
BASH_UNIT_SOURCE="https://github.com/bash-unit/bash_unit/archive/refs/tags/v${BASH_UNIT_VERSION}.tar.gz"

TMP_DIR=".tmp"
BASH_UNIT_SCRIPT="${TMP_DIR}/bash_unit_${BASH_UNIT_VERSION}"
ARCHIVE_PATH="${TMP_DIR}/bash_unit_${BASH_UNIT_VERSION}.tar.gz"

mkdir -p "$TMP_DIR"

# Check if script already exists
if [[ ! -f "$BASH_UNIT_SCRIPT" ]]; then
  echo "bash_unit script not found, downloading..."

  # Download the archive
  curl -sSL "$BASH_UNIT_SOURCE" -o "$ARCHIVE_PATH"

  # Verify SHA-256 checksum
  if ! echo "${BASH_UNIT_SHA256}  ${ARCHIVE_PATH}" | sha256sum -c -; then
    echo "SHA256 checksum verification failed!"
    exit 1
  fi

  # Extract only the bash_unit script from archive to destination
  TAR_PATH="bash_unit-${BASH_UNIT_VERSION}/bash_unit"
  tar --extract --gzip --file="$ARCHIVE_PATH" --directory="$TMP_DIR" --strip-components=1 "$TAR_PATH"

  # Rename/move the script to the expected path
  mv "${TMP_DIR}/bash_unit" "$BASH_UNIT_SCRIPT"
  chmod +x "$BASH_UNIT_SCRIPT"
fi

# Run the script with passed arguments
"$BASH_UNIT_SCRIPT" "$@"